<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Beagle Systems — AGL Visualizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/darkly/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { background: #121212; color: #eee; font-family: "Inter", sans-serif; text-align: center; }
    #map { height: 45vh; width: 100%; border-radius: 10px; margin-bottom: 2em; }
    .logo { height: 50px; position: absolute; right: 20px; top: 20px; }
    .chart-container { width: 90%; height: 50vh; margin: 0 auto; }
    #aglChart { display: block; width: 100% !important; height: 100% !important; margin: 0 auto; }
    canvas { border-radius: 10px; background: #1e1e1e; padding: 1em; }
    .status { font-weight: 500; color: #0dcaf0; }
    .header { position: relative; margin-bottom: 2rem; }
    .header h2 { text-align: center; margin: 0; }
  </style>
</head>
<body class="p-4">
  <div class="header">
    <h2>Beagle Systems — AGL Route Visualizer</h2>
    <img src="https://static.wixstatic.com/media/4e71d1_217b03ae9b52445e85f0cbf9839ce322~mv2.png" alt="Beagle Logo" class="logo">
  </div>
  <div class="mb-4">
    <label class="form-label">Upload AGL CSV:</label>
    <input type="file" id="fileInput" accept=".csv" class="form-control w-auto d-inline-block" />
    <span id="status" class="ms-3 status"></span>
  </div>
  <div id="map"></div>
  <h5>Above Ground Level (AGL) Profile</h5>
  <div class="chart-container">
    <canvas id="aglChart"></canvas>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const map = L.map('map').setView([51, 10], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap',
      maxZoom: 19
    }).addTo(map);

    let aglChart, hoverMarker;
    let polylineSegments = [];
    let lowMarkers = [];
    let pointList = [];

    const blackIcon = new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        complete: function(results) {
          const data = results.data.filter(row => row.lat && row.lon && row.AGL != null && row.AGL >= 0);
          if (data.length < 2) { alert("At least two valid points with non-negative AGL are required."); return; }
          pointList = data.map((row, i) => ({ lat: row.lat, lon: row.lon, agl: row.AGL, index: i }));
          document.getElementById('status').innerText = `✔️ Loaded ${pointList.length} points`;
          visualize();
        }
      });
    });

    function visualize() {
      map.setView([pointList[0].lat, pointList[0].lon], 15);

      polylineSegments.forEach(seg => map.removeLayer(seg));
      polylineSegments = [];
      lowMarkers.forEach(m => map.removeLayer(m));
      lowMarkers = [];

      for (let i = 0; i < pointList.length - 1; i++) {
        const p1 = pointList[i];
        const p2 = pointList[i + 1];
        const belowThreshold = (p1.agl < 60 || p2.agl < 60);
        const color = belowThreshold ? 'red' : 'yellow';

        const segment = L.polyline([[p1.lat, p1.lon], [p2.lat, p2.lon]], {
          color: color,
          weight: 5,
          opacity: 0.9
        }).addTo(map);

        segment.on('mouseover', () => highlight(i));
        polylineSegments.push(segment);

        if (belowThreshold) {
          const midLat = (p1.lat + p2.lat) / 2;
          const midLon = (p1.lon + p2.lon) / 2;
          const aglAvg = ((p1.agl + p2.agl) / 2).toFixed(1);
          const marker = L.marker([midLat, midLon], { icon: blackIcon }).addTo(map);
          marker.bindPopup(`<b>LOW AGL: ${aglAvg} m</b>`);
          lowMarkers.push(marker);
        }
      }

      if (hoverMarker) map.removeLayer(hoverMarker);
      hoverMarker = L.circleMarker([pointList[0].lat, pointList[0].lon], {
        radius: 8,
        color: 'yellow',
        fillColor: 'yellow',
        fillOpacity: 1
      }).addTo(map);

      createChart(pointList);
    }

    function createChart(points) {
      const ctx = document.getElementById('aglChart').getContext('2d');
      if (aglChart) aglChart.destroy();

      const labels = points.map((_, i) => `P${i + 1}`);
      const data = points.map(p => p.agl);
      const bgColors = points.map(p => p.agl < 60 ? 'red' : 'cyan');

      aglChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: [{ label: 'AGL (m)', data: data, backgroundColor: bgColors }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          devicePixelRatio: 2,
          onHover: (event, chartElements) => {
            const index = chartElements.length ? chartElements[0].index : null;
            if (index !== null) {
              const point = pointList[index];
              if (point) hoverMarker.setLatLng([point.lat, point.lon]);
            }
          },
          plugins: {
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw} m` } }
          },
          scales: {
            y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: '#555' }, title: { display: true, text: 'AGL (m)' } },
            x: { ticks: { color: '#fff' }, grid: { color: '#555' }, title: { display: true, text: 'Route Points' } }
          },
          animation: {
            onComplete: function() {
              const chart = aglChart;
              const ctx = chart.ctx;
              chart.data.datasets[0].data.forEach((value, index) => {
                if (value < 60 && value >= 0) {
                  const meta = chart.getDatasetMeta(0).data[index];
                  ctx.save();
                  ctx.fillStyle = 'yellow';
                  ctx.font = 'bold 16px Arial';
                  ctx.fillText('🚩', meta.x - 5, meta.y - 10);
                  ctx.restore();
                }
              });
            }
          }
        }
      });
    }

    function highlight(index) {
      const point = pointList[index];
      if (point) {
        hoverMarker.setLatLng([point.lat, point.lon]);
        aglChart.setActiveElements([{ datasetIndex: 0, index: index }]);
        aglChart.tooltip.setActiveElements([{ datasetIndex: 0, index: index }]);
        aglChart.update();
      }
    }
  </script>
</body>
</html>
